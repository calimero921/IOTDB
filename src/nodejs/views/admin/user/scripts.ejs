<script type="text/javascript">
    $(document).ready(function () {
        $("#usersTable").tablesorter({
            sortList: [[0, 1]],
            headers: {
                3: {sorter: false}
            }

        });

        $('[data-toggle="tooltip"]').tooltip();
    });

    $('#addItem').on('click', function () {
        $("#editemail").val("");
        $("#editpassword").val("");
        $("#editfirstname").val("");
        $("#editlastname").val("");
        $("#editadmin").prop('checked', false);
    });

    function getUser(email) {
        $.getJSON('/user/email/' + email,
            function (data) {
                if (data.length > 0) {
                    $("#editemail").val(data[0].email);
                    $("#editpassword").val(data[0].password);
                    $("#editfirstname").val(data[0].firstname);
                    $("#editlastname").val(data[0].lastname);
                    $("#editadmin").prop('checked', data[0].admin);
                }
            }
        );
    }

    function delUser(email) {
        var url = '/admin/user';

        $("#dialog-text").text("Are you sure you want to delete this user ?");
        $("#dialog-confirm").dialog({
            title: "Confirmation",
            resizable: false,
            height: "auto",
            width: 400,
            modal: true,
            buttons: {
                "Ok": function () {
                    $(this).dialog("close");
                    promiseDelUser(email)
                        .then(function() {displayResult(true)})
                        .catch(function(err) {displayResult(false, "", err)});
                },
                "Cancel": function () {
                    $(this).dialog("close");
                }
            }
        });
    }

    function submitForm() {
        var url = '/admin/user';

        promiseSetUser()
            .then(function() {displayResult(true)})
            .catch(function(err) {displayResult(false, "", err)});

    }

    function resetPassword() {
        var url = '/admin/user';

        var result;
        var login = $("#editemail").val();

        $.getJSON('/user/recover/' + login,
            function(data) {
                if(typeof data === 'undefined') {
                    displayResult(false, "", "error while verifying your credentials");
                } else {
                    switch(data.code) {
                        case "250":
                            window.location.assign("/admin/user");
                            break;
                        default:
                            displayResult(false, "", "error sending password reset link, please check your email");
                            break;
                    }
                }
            }
        );
    }

    function promiseSetUser() {
        return new Promise(function (resolve, reject) {
            try {
                var data = {};
                data.email = $("#editemail").val();
                data.password = "";
                data.firstname = $("#editfirstname").val();
                data.lastname = $("#editlastname").val();
                data.admin = $("#editadmin").prop("checked");

                var jqxhr = $.post('/user', JSON.stringify(data))
                    .done(function(datas) {resolve(datas)})
                    .fail(function(error) {reject(error)});
            } catch (err) {
                reject(err);
            }
        });
    }

    function promiseDelUser(email) {
        return new Promise(function (resolve, reject) {
            try {
                $.ajax({url: '/user/' + email, type: 'DELETE'})
                    .done(function() {resolve('Ok')})
                    .fail(function() {reject('Error calling API')});
            } catch (err) {reject(err)}
        });
    }
</script>
<%- include('../../include/displayresult'); %>